@{
    Layout = null;
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <title>Application</title>
    @Html.Partial("CSSPartial")

    <style>
        tfoot {
            display: table-header-group;
        }
        tfoot input {
            width: 100%;
            padding: 3px;
            box-sizing: border-box;
        }
        .dataTables_scroll {
            overflow: auto;
            width: 100%;
        }
    </style>

</head>
<body>
    <div id="wrapper">
        <!-- Navigation -->
        <nav class="navbar navbar-default navbar-static-top" role="navigation" style="margin-bottom: 0">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="index.html">Application</a>
            </div>
            <!-- /.navbar-top-links -->
            <div class="navbar-default sidebar" role="navigation">
                <div class="sidebar-nav navbar-collapse">
                    <ul class="nav" id="side-menu">
                        <li>
                            <a href="index.html"><i class="fa fa-dashboard fa-fw"></i> Dashboard</a>
                        </li>
                    </ul>
                </div>
                <!-- /.sidebar-collapse -->
            </div>
            <!-- /.navbar-static-side -->
        </nav>
        <div id="page-wrapper">
            <div class="row">
                <div class="col-lg-12">
                    <h1 class="page-header">Dashboard</h1>
                </div>
                <!-- /.col-lg-12 -->
            </div>
            <!-- /.row -->
            <div class="row">
                <div class="col-lg-12">
                    <div class="form-group">
                        <label>Upload CSV file...</label>
                        <li id="spinner" style="display: none" class="fa fa-spinner fa-spin"></li><span id="percentage" style="font-size: 12px"></span>
                        <input type="file" accept=".csv" id="inputFile">
                        <div class="progress progressBar1" style="margin-top: 3px; display: none" >
                            <div class="progress-bar progress-bar-striped active" role="progressbar"
                                 aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width:0%">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-lg-9">
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            CSV file entries.
                        </div>
                        <!-- /.panel-heading -->
                        <div class="panel-body">
                            <div class="dataTable_wrapper">
                                <table width="100%" class="table table-striped table-bordered table-hover" id="myTable">
                                    <thead>
                                        <tr>
                                            <th>Gender</th>
                                            <th>Title</th>
                                            <th>Occupation</th>
                                            <th>Company</th>
                                            <th>Given Name</th>
                                            <th>Middle Initial</th>
                                            <th>Surname</th>
                                            <th>Blood Type</th>
                                            <th>Email Address</th>
                                        </tr>
                                    </thead>
                                    <tfoot>
                                        <tr>
                                            <th>Gender</th>
                                            <th>Title</th>
                                            <th>Occupation</th>
                                            <th>Company</th>
                                            <th>Given Name</th>
                                            <th>Middle Initial</th>
                                            <th>Surname</th>
                                            <th>Blood Type</th>
                                            <th>Email Address</th>
                                        </tr>
                                    </tfoot>
                                    <tbody></tbody>
                                </table>
                            </div>
                            <!-- /.table-responsive -->
                        </div>
                        <!-- /.panel-body -->
                    </div>
                    <!-- /.panel -->
                </div>
                <div class="col-lg-3">
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            Selected Row
                            <button type="button" class="btn btn-primary btn-xs pull-right" id="btnAddNewEntry">Add new entry</button>
                            <button type="button" class="btn btn-success btn-xs pull-right" style="display: none" id="btnAdd">Add</button>
                            <button type="button" class="btn btn-danger btn-xs pull-right" id="btnCancel" style="margin-right: 3px; display: none">Cancel</button>
                        </div>
                        <!-- /.panel-heading -->
                        <div class="panel-body">
                            <form role="form">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Gender</label>
                                        <input class="form-control" id="inputGender" readonly>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Title</label>
                                        <input class="form-control" id="inputTitle" readonly>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Occupation</label>
                                        <input class="form-control" id="inputOccupation" readonly>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Company</label>
                                        <input class="form-control" id="inputCompany" readonly>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Given Name</label>
                                        <input class="form-control" id="inputGivenName" readonly>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Middle Initial</label>
                                        <input class="form-control" id="inputMiddleInitial" readonly>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Surname</label>
                                        <input class="form-control" id="inputSurname" readonly>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Blood Type</label>
                                        <input class="form-control" id="inputBloodType" readonly>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Email Address</label>
                                        <input class="form-control" id="inputEmailAddress" readonly>
                                    </div>
                                </div>
                            </form>
                            <!-- /.table-responsive -->
                        </div>
                        <!-- /.panel-body -->
                    </div>
                    <!-- /.panel -->
                </div>
                <!-- /.col-lg-12 -->
            </div>
            <!-- /.row -->
        </div>
        <!-- /#page-wrapper -->
    </div>
    <!-- /#wrapper -->
    @Html.Partial("JSPartial")
    <script>
        function FilterBeingUsed(filter) {
            if(filter.val() == '') {
                return false;
            } else {
                return true;
            }
        }

        $(document).ready(function () {
            var table = $('#myTable').DataTable({
                dom: 'lBfrtip',
                //responsive: true,
                colReorder: true,
                select: {
                    style: 'single'
                },
                "columns": [
                { "data": "Gender" },
                { "data": "Title" },
                { "data": "Occupation" },
                { "data": "Company" },
                { "data": "GivenName" },
                { "data": "MiddleInitial" },
                { "data": "Surname" },
                { "data": "BloodType" },
                { "data": "EmailAddress" },
                ],
                buttons: [
                'csv', 'excel', 'pdf',
                {
                    extend: 'print',
                    customize: function (win) {
                        var Gender = $(".Gender").val();
                        var Title = $(".Title").val();
                        var Occupation = $(".Occupation").val();
                        var Company = $(".Company").val();
                        var GivenName = $(".GivenName").val();
                        var MiddleInitial = $(".MiddleInitial").val();
                        var Surname = $(".Surname").val();
                        var BloodType = $(".BloodType").val();
                        var EmailAddress = $(".EmailAddress").val();

                        var auxFilterAlertMessage = "";
                        var auxFilterString = "";
                        try {
                            if (FilterBeingUsed($(".Gender"))) {
                                auxFilterString += " | Gender: <b>" + Gender + "</b>";
                            }
                            if (FilterBeingUsed($(".Title"))) {
                                auxFilterString += " | Title: <b>" + Title + "</b>";
                            }
                            if (FilterBeingUsed($(".Occupation"))) {
                                auxFilterString += " | Occupation: <b>" + Occupation + "</b>";
                            }
                            if (FilterBeingUsed($(".Company"))) {
                                auxFilterString += " | Company: <b>" + Company + "</b>";
                            }
                            if (FilterBeingUsed($(".GivenName"))) {
                                auxFilterString += " | GivenName: <b>" + GivenName + "</b>";
                            }
                            if (FilterBeingUsed($(".MiddleInitial"))) {
                                auxFilterString += " | MiddleInitial: <b>" + MiddleInitial + "</b>";
                            }
                            if (FilterBeingUsed($(".Surname"))) {
                                auxFilterString += " | Surname: <b>" + Surname + "</b>";
                            }
                            if (FilterBeingUsed($(".BloodType"))) {
                                auxFilterString += " | BloodType: <b>" + BloodType + "</b>";
                            }
                            if (FilterBeingUsed($(".EmailAddress"))) {
                                auxFilterString += " | EmailAddress: <b>" + EmailAddress + "</b>";
                            }
                        } catch (Ex) {
                            alert(Ex);
                        }

                        if (auxFilterString!= "") {
                            auxFilterAlertMessage = "[!] This data is being filtered by: <br>";
                        }

                        $(win.document.body)
                            .css( 'font-size', '10pt' )
                            .prepend(
                                '<p>' + auxFilterAlertMessage + auxFilterString + '</p>'
                            );

                        $(win.document.body).find( 'table' )
                            .addClass( 'compact' )
                            .css( 'font-size', 'inherit' );
                    }
                },
                ]
            });

            $("#myTable").wrap('<div class="dataTables_scroll" />');

            table
            .on('select', function (e, dt, type, indexes) {
                var rowData = table.rows(indexes).data().toArray();
                //events.prepend('<div><b>' + type + ' selection</b> - ' + JSON.stringify(rowData) + '</div>');
                // Gender,Title,Occupation,Company,GivenName,MiddleInitial,Surname,BloodType,EmailAddress
                $("#inputGender").val(rowData[0]["Gender"]);
                $("#inputTitle").val(rowData[0]["Title"]);
                $("#inputOccupation").val(rowData[0]["Occupation"]);
                $("#inputCompany").val(rowData[0]["Company"]);
                $("#inputGivenName").val(rowData[0]["GivenName"]);
                $("#inputMiddleInitial").val(rowData[0]["MiddleInitial"]);
                $("#inputSurname").val(rowData[0]["Surname"]);
                $("#inputBloodType").val(rowData[0]["BloodType"]);
                $("#inputEmailAddress").val(rowData[0]["EmailAddress"]);
            })
            .on('deselect', function (e, dt, type, indexes) {
                $("#inputGender").val('');
                $("#inputTitle").val('');
                $("#inputOccupation").val('');
                $("#inputCompany").val('');
                $("#inputGivenName").val('');
                $("#inputMiddleInitial").val('');
                $("#inputSurname").val('');
                $("#inputBloodType").val('');
                $("#inputEmailAddress").val('');
            });

            //$('#myTable tfoot th').each(function () {
            //    var title = $(this).text();
            //    $(this).html('<input class="' + title.replace(/\s/g, '') + '" data-title="' + title + '" type="text" placeholder="Search ' + title + '" />');
            //});

            $('#myTable tfoot th').each(function () {
                var title = $('#myTable thead th').eq($(this).index()).text();
                //$(this).html('<input type="text" placeholder="Search ' + title + '" />');
                $(this).html('<input class="' + title.replace(/\s/g, '') + '" data-title="' + title + '" type="text" placeholder="Search ' + title + '" />');
            });

            $("#myTable").DataTable().columns().every(function () {
                var that = this;

                $('input', this.footer()).on('keyup change', function () {
                    var exactMatchColumns = ["Gender", "Title", "Occupation", "Company", "BloodType"];

                    if ($.inArray($.trim($(this).data("title")), exactMatchColumns) != -1) {
                        console.log("Exact match");
                        // Exact Match
                        if (this.value != "") {
                            if (that.search() !== this.value) {
                                //that.search(this.value).draw();
                                that.search("^" + this.value + "$", true, false, true).draw();
                            }
                        } else {
                            that.search(this.value).draw();
                        }
                    } else {
                        // Not Exact Match
                        that.search(this.value).draw();
                    }
                });
            });

            $("#myTable").DataTable().on('column-reorder', function (e, settings, details) {
                $('#myTable tfoot th').each(function () {
                    var title = $('#myTable thead th').eq($(this).index()).text();
                    //$(this).html('<input type="text" placeholder="Search ' + title + '" />');
                    $(this).html('<input class="' + title.replace(/\s/g, '') + '" data-title="' + title + '" type="text" placeholder="Search ' + title + '" />');
                });

                $("#myTable").DataTable().columns().every(function () {
                    var that = this;

                    $('input', this.footer()).on('keyup change', function () {
                        var exactMatchColumns = ["Gender", "Title", "Occupation", "Company", "BloodType"];

                        console.log("Working");
                        if ($.inArray($.trim($(this).data("title")), exactMatchColumns) != -1) {
                            // Exact Match
                            if (this.value != "") {
                                if (that.search() !== this.value) {
                                    //that.search(this.value).draw();
                                    that.search("^" + this.value + "$", true, false, true).draw();
                                }
                            } else {
                                that.search(this.value).draw();
                            }
                        } else {
                            // Not Exact Match
                            that.search(this.value).draw();
                        }
                    });
                });
            });
        });
    </script>

    <script>
        // ProgressBar Handling
        function progressHandlingFunction(e) {
            if (e.lengthComputable) {
                //$('progress').attr({ value: e.loaded, max: e.total });
                var percentage = (e.loaded * 100) / e.total;
                $("#percentage").text(" " + percentage.toFixed(2) + "%");
                $(".progressBar1").find(".progress-bar").text(percentage.toFixed(2) + "%");
                $(".progressBar1").find(".progress-bar").attr('aria-valuenow', percentage).css('width', percentage + "%");

                if (percentage == 100) {
                    $(".progressBar1").hide(1);
                    $(".progressBar1").find(".progress-bar").text("0");
                    $(".progressBar1").find(".progress-bar").attr('aria-valuenow', 0).css('width', 0+ "%");
                }
            }
        }

        $("#inputFile").change(function () {
            var FilePath = $(this).val();
            if (FilePath != "") {
                $("#spinner").show(1);
                $(".progressBar1").show(1);

                $('#myTable').DataTable().clear().draw();
                $("#spinner").show(300);
                var fileUpload = $("#inputFile").get(0);
                var files = fileUpload.files;

                // Create FormData object
                var fileData = new FormData();

                // Looping over all files and add it to FormData object
                for (var i = 0; i < files.length; i++) {
                    fileData.append(files[i].name, files[i]);
                }

                // Each row progress bar
                var total = 0;
                var percentage = 0;
                var actual = 0;
                //// Adding one more key to FormData object
                //fileData.append('username', ‘Manas’);

                $.ajax({
                    url: '@Url.Action("LoadCSV", "Home")',
                    type: "POST",
                    xhr: function () {  // Custom XMLHttpRequest
                        var myXhr = $.ajaxSettings.xhr();
                        if (myXhr.upload) { // Check if upload property exists
                            myXhr.upload.addEventListener('progress', progressHandlingFunction, false); // For handling the progress of the upload
                        }
                        return myXhr;
                    },
                    contentType: false, // Not to set any content header
                    processData: false, // Not to process data
                    data: fileData,
                    success: function (result) {
                        $(".progressBar1").show(1);
                        var obj = jQuery.parseJSON(result);
                        total = obj.length;
                        //$.each(obj, function (index, value) {
                            
                        //});
                        $(".progressBar1").show(1);
                        var i = 0;
                        (function doSort() {
                            // update progress
                            actual += 1;
                            percentage = (actual * 100) / total;
                            console.log(percentage);

                            $(".progressBar1").find(".progress-bar").text(percentage.toFixed(2) + "%");
                            $(".progressBar1").find(".progress-bar").attr('aria-valuenow', percentage).css('width', percentage + "%");

                            var Gender = obj[i][0];
                            var Title = obj[i][1];
                            var Occupation = obj[i][2];
                            var Company = obj[i][3];
                            var GivenName = obj[i][4];
                            var MiddleInitial = obj[i][5];
                            var Surname = obj[i][6];
                            var BloodType = obj[i][7];
                            var EmailAddress = obj[i][8];



                            //$('#myTable').DataTable().row.add([Gender, Title, Occupation, Company, GivenName, MiddleInitial, Surname, BloodType, EmailAddress]).draw().node();
                            $('#myTable').DataTable().row.add({
                                "Gender": Gender,
                                "Title": Title,
                                "Occupation": Occupation,
                                "Company": Company,
                                "GivenName": GivenName,
                                "MiddleInitial": MiddleInitial,
                                "Surname": Surname,
                                "BloodType": BloodType,
                                "EmailAddress": EmailAddress,
                            }).draw();

                            if (percentage == 100) {
                                $(".progressBar1").hide(1);
                                $(".progressBar1").find(".progress-bar").text("0");
                                $(".progressBar1").find(".progress-bar").attr('aria-valuenow', 0).css('width', 0 + "%");
                            }

                            // do stuff
                            i++;
                            if (i < total) {
                                setTimeout(doSort, 0);
                            }
                        })();
                    },
                    error: function (err) {
                        $("#spinner").hide(1);
                        alert(err);
                    },
                    complete: function () {
                        $("#spinner").hide(1);
                    }
                });
            }
        });
    </script>

    <script>
        function NewEntryMode() {
            $("#btnCancel").show(300);
            $("#btnAddNewEntry").hide(300);

            $("#inputGender").val('');
            $("#inputTitle").val('');
            $("#inputOccupation").val('');
            $("#inputCompany").val('');
            $("#inputGivenName").val('');
            $("#inputMiddleInitial").val('');
            $("#inputSurname").val('');
            $("#inputBloodType").val('');
            $("#inputEmailAddress").val('');

            $("#inputGender").prop("readonly", false);
            $("#inputTitle").prop("readonly", false);
            $("#inputOccupation").prop("readonly", false);
            $("#inputCompany").prop("readonly", false);
            $("#inputGivenName").prop("readonly", false);
            $("#inputMiddleInitial").prop("readonly", false);
            $("#inputSurname").prop("readonly", false);
            $("#inputBloodType").prop("readonly", false);
            $("#inputEmailAddress").prop("readonly", false);

            $("#btnAdd").show(300);
            $("#inputGender").focus();
        }

        function NormalMode() {
            $("#btnCancel").hide(300);
            $("#btnAddNewEntry").show(300);

            $("#inputGender").val('');
            $("#inputTitle").val('');
            $("#inputOccupation").val('');
            $("#inputCompany").val('');
            $("#inputGivenName").val('');
            $("#inputMiddleInitial").val('');
            $("#inputSurname").val('');
            $("#inputBloodType").val('');
            $("#inputEmailAddress").val('');

            $("#inputGender").prop("readonly", true);
            $("#inputTitle").prop("readonly", true);
            $("#inputOccupation").prop("readonly", true);
            $("#inputCompany").prop("readonly", true);
            $("#inputGivenName").prop("readonly", true);
            $("#inputMiddleInitial").prop("readonly", true);
            $("#inputSurname").prop("readonly", true);
            $("#inputBloodType").prop("readonly", true);
            $("#inputEmailAddress").prop("readonly", true);

            $("#btnAdd").hide(300);
            $("#btnAdd").text('Add');
            $("#btnAdd").removeClass("fa fa-check", 500);
        }

        $("#btnAddNewEntry").click(function () {
            NewEntryMode();
        });

        $("#btnCancel").click(function () {
            NormalMode();
        });

        $("#btnAdd").click(function () {
            try {
                //$('#myTable').DataTable().row.add([$("#inputGender").val(), $("#inputTitle").val(), $("#inputOccupation").val(), $("#inputCompany").val(), $("#inputGivenName").val(), $("#inputMiddleInitial").val(), $("#inputSurname").val(), $("#inputBloodType").val(), $("#inputEmailAddress").val()]).draw().node();
                $('#myTable').DataTable().row.add({
                    "Gender": $("#inputGender").val(),
                    "Title": $("#inputTitle").val(),
                    "Occupation": $("#inputOccupation").val(),
                    "Company": $("#inputCompany").val(),
                    "GivenName": $("#inputGivenName").val(),
                    "MiddleInitial": $("#inputMiddleInitial").val(),
                    "Surname": $("#inputSurname").val(),
                    "BloodType": $("#inputBloodType").val(),
                    "EmailAddress": $("#inputEmailAddress").val(),
                }).draw();
                $("#btnAdd").text('');
                $("#btnAdd").addClass("fa fa-check", 500);
                window.setTimeout(function () { NormalMode() }, 500);
                
            } catch (Ex) {
                alert("Error: " + Ex);
            }
        });
    </script>
</body>
</html>
